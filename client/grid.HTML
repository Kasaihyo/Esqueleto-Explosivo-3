<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cluster Avalanche – v5 (balanced timings)</title>
  <style>
    :root{
      --bg-dark:#222;
      --bg-panel:#111;
      --bg-grid:#333;
      --gold-light:#ffd700;
      --gold-dark:#b8860b;
      --size:clamp(52px,14vmin,88px);
      --gap:6px;
      --r:8px;
      /* Slower, more natural drop */
      --t-med: .48s;
      /* Quick explode */
      --t-fast: .25s;
    }
    *,*:before,*:after{box-sizing:border-box;margin:0}
    body{font-family:system-ui,sans-serif;background:var(--bg-dark);color:#fff;display:flex;align-items:center;justify-content:center;min-height:100dvh;padding:1rem;overflow:hidden}
    .game{display:flex;flex-direction:column;align-items:center;gap:1rem;padding:1.5rem;background:var(--bg-panel);border-radius:var(--r);box-shadow:0 0 18px rgba(0,0,0,.6);width:clamp(310px,92vw,540px)}
    h1{font-size:clamp(1.5rem,5vw,2.1rem);color:var(--gold-light);text-shadow:0 0 10px rgba(255,215,0,.65);letter-spacing:1px;text-align:center}
    .info{display:grid;grid-template-columns:repeat(3,1fr);gap:.4rem;width:100%;background:var(--bg-grid);padding:.6rem;border-radius:var(--r)}
    .info small{font-size:.65rem;color:#aaa}
    .info span{font-weight:600;font-size:1.15rem}
    .grid{--n:5;position:relative;display:grid;grid-template-columns:repeat(var(--n),var(--size));grid-auto-rows:var(--size);gap:var(--gap);padding:var(--gap);background:var(--bg-grid);border-radius:var(--r);box-shadow:inset 0 0 10px rgba(0,0,0,.55);overflow:hidden}
    .cell{width:var(--size);height:var(--size);display:flex;align-items:center;justify-content:center;border-radius:var(--r);font-weight:700;font-size:clamp(.58rem,2.2vw,.92rem)}
    .gold{background:radial-gradient(circle,var(--gold-light),var(--gold-dark));color:#000}
    .pink{background:radial-gradient(circle,#ff80ab,#c2185b)}
    .green{background:radial-gradient(circle,#81c784,#2e7d32)}
    .blue{background:radial-gradient(circle,#64b5f6,#1565c0)}
    .orange{background:radial-gradient(circle,#ffb74d,#ef6c00)}
    .cyan{background:radial-gradient(circle,#4dd0e1,#00838f)}
    @keyframes fall{from{transform:translateY(-600%);opacity:.6}to{transform:translateY(0);opacity:1}}
    @keyframes explode{0%{transform:scale(1);opacity:1}50%{transform:scale(1.2);opacity:.85}100%{transform:scale(0);opacity:0}}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
    .fall{animation:fall var(--t-med) cubic-bezier(.2,.8,.2,1)}
    .explode{animation:explode var(--t-fast) forwards}
    .highlight{animation:pulse var(--t-med) infinite;box-shadow:0 0 12px #fff;z-index:1}
    .controls{width:100%;display:flex;flex-direction:column;align-items:center;gap:.8rem}
    button{appearance:none;background:linear-gradient(#f9d423,#e65c00);border:none;padding:.8rem 2.4rem;border-radius:50px;color:#fff;font-weight:600;font-size:clamp(.9rem,3vw,1.1rem);cursor:pointer;box-shadow:0 4px 14px rgba(230,92,0,.4);transition:.25s}
    button:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(230,92,0,.55)}
    button:active{transform:translateY(1px)}
    button:disabled{background:#555;box-shadow:none;cursor:not-allowed;transform:none}
    .win{font-size:clamp(1rem,3.5vw,1.55rem);min-height:1.6em;text-align:center;color:var(--gold-light)}
    .multiplier{position:absolute;top:-1.7rem;right:-1.7rem;background:#c62828;color:#fff;width:2.5rem;height:2.5rem;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:0 0 10px rgba(0,0,0,.6);opacity:0;transition:opacity .25s}
    .multiplier.show{opacity:1;animation:pulse 1s infinite}
  </style>
</head>
<body>
  <main class="game" id="gameRoot">
    <h1>CLUSTER AVALANCHE</h1>
    <section class="info">
      <div><small>BALANCE</small><span data-ui="balance">100.00</span></div>
      <div><small>BET</small><span data-ui="bet">1.00</span></div>
      <div><small>AVALANCHE</small><span data-ui="avalanche">0</span></div>
    </section>
    <div class="grid" data-ui="grid"></div>
    <div class="multiplier" data-ui="multiplier">x1</div>
    <p class="win" data-ui="win"></p>
    <div class="controls"><button data-ui="spin">SPIN</button></div>
  </main>
  <script type="module">
    const N=5;
    const FIRST_FILL_DELAY=25;
    const AVALANCHE_FILL_DELAY=25;
    const SYMS=[
      {k:'gold',t:'GOLD',v:5,w:.05},
      {k:'pink',t:'PNK',v:.2,w:.19},
      {k:'green',t:'GRN',v:.2,w:.19},
      {k:'blue',t:'BLU',v:.2,w:.19},
      {k:'orange',t:'ORG',v:.2,w:.19},
      {k:'cyan',t:'CYN',v:.2,w:.19},
    ];
    const $=(s,r=document)=>r.querySelector(s);
    const randWeighted=()=>{let r=Math.random(),acc=0;for(const s of SYMS){acc+=s.w;if(r<acc)return s;}return SYMS[SYMS.length-1];};
    const sleep=ms=>new Promise(r=>setTimeout(r,ms));
    class Game{
      constructor(root){
        this.root=root;
        this.gridElm=$('[data-ui="grid"]',root);
        this.ui={
          bal:$('[data-ui="balance"]',root),
          bet:$('[data-ui="bet"]',root),
          aval:$('[data-ui="avalanche"]',root),
          mult:$('[data-ui="multiplier"]',root),
          win:$('[data-ui="win"]',root),
          btn:$('[data-ui="spin"]',root)
        };
        this.state={bal:100,bet:1,aval:0,mult:1,total:0,spinning:false,grid:Array.from({length:N},()=>Array(N).fill(null))};
        this.createGrid();this.bind();this.clearGridInstant();
      }
      createGrid(){
        this.gridElm.style.setProperty('--n',N);
        this.cells=Array.from({length:N},()=>Array(N));
        this.gridElm.innerHTML='';
        for(let r=0;r<N;r++)for(let c=0;c<N;c++){const d=document.createElement('div');d.className='cell';this.gridElm.appendChild(d);this.cells[r][c]=d;}
      }
      bind(){this.ui.btn.addEventListener('click',()=>this.spin());}
      UI(){
        this.ui.bal.textContent=this.state.bal.toFixed(2);
        this.ui.bet.textContent=this.state.bet.toFixed(2);
        this.ui.aval.textContent=this.state.aval;
        this.ui.mult.textContent=`x${this.state.mult}`;
        this.ui.mult.classList.toggle('show',this.state.aval>0);
      }
      async spin(){
        if(this.state.spinning)return;
        if(this.state.bal<this.state.bet){alert('Insufficient balance');return;}
        this.state.spinning=true;
        this.state.bal-=this.state.bet;
        this.state.aval=0;this.state.mult=1;this.state.total=0;
        this.ui.win.textContent='';this.ui.btn.disabled=true;
        this.clearGridInstant();
        await this.fillHoles(false);
        await this.resolveClusters();
        this.state.spinning=false;
        this.ui.btn.disabled=false;
      }
      clearGridInstant(){
        for(let r=0;r<N;r++)for(let c=0;c<N;c++){this.state.grid[r][c]=null;const cell=this.cells[r][c];cell.className='cell';cell.textContent='';}
        this.UI();
      }
      async fillHoles(isAval){
        const empties=[];
        for(let r=0;r<N;r++)for(let c=0;c<N;c++)if(!this.state.grid[r][c])empties.push({r,c});
        empties.sort((a,b)=>b.r-a.r);
        const delay=isAval?AVALANCHE_FILL_DELAY:FIRST_FILL_DELAY;
        for(const [i,pos] of empties.entries()){await sleep(i*delay);const sym=randWeighted();this.place(pos.r,pos.c,sym,'fall');}
        if(empties.length)await sleep(350);
      }
      place(r,c,s,cls=''){this.state.grid[r][c]=s;const cell=this.cells[r][c];cell.className=`cell ${s.k} ${cls}`.trim();cell.textContent=s.t;}
      async resolveClusters(){
        const clusters=this.findClusters();
        if(!clusters.length){this.ui.win.textContent=this.state.total?`TOTAL WIN ${this.state.total.toFixed(2)}`:'NO WIN';this.state.bal+=this.state.total;this.UI();return;}
        this.state.aval++;this.state.mult=this.state.aval;this.UI();
        const toErase=[];let roundWin=0;
        clusters.forEach(cluster=>{const sym=this.state.grid[cluster[0].r][cluster[0].c];roundWin+=sym.v*cluster.length*this.state.bet*this.state.mult;cluster.forEach(({r,c})=>{this.cells[r][c].classList.add('highlight');toErase.push({r,c});});});
        this.state.total+=roundWin;this.ui.win.textContent=`WIN ${roundWin.toFixed(2)}`;
        await sleep(300);
        toErase.forEach(({r,c})=>{this.cells[r][c].className='cell explode';this.state.grid[r][c]=null;});
        await sleep(200);
        this.compactDown();
        await this.fillHoles(true);
        await this.resolveClusters();
      }
      compactDown(){for(let c=0;c<N;c++){const syms=[];for(let r=N-1;r>=0;r--){if(this.state.grid[r][c]){syms.push(this.state.grid[r][c]);this.state.grid[r][c]=null;}const cell=this.cells[r][c];cell.className='cell';cell.textContent='';}let wr=N-1;syms.forEach(s=>{this.place(wr--,c,s,'fall');});}}
      findClusters(){
        const seen=Array.from({length:N},()=>Array(N).fill(false));
        const out=[];
        const dfs=(r,c,s,arr)=>{if(r<0||r>=N||c<0||c>=N||seen[r][c]||this.state.grid[r][c]?.k!==s.k)return;seen[r][c]=true;arr.push({r,c});dfs(r+1,c,s,arr);dfs(r-1,c,s,arr);dfs(r,c+1,s,arr);dfs(r,c-1,s,arr);};
        for(let r=0;r<N;r++){for(let c=0;c<N;c++){if(!seen[r][c]&&this.state.grid[r][c]){const arr=[];dfs(r,c,this.state.grid[r][c],arr);if(arr.length>=5)out.push(arr);}}}
        return out;
      }
    }
    new Game(document.getElementById('gameRoot'));
  </script>
</body>
</html>
